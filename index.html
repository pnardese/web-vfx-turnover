<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VFX Turnover Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;

        const VFXTurnoverApp = () => {
            const [currentPage, setCurrentPage] = useState('main');
            const [edlData, setEdlData] = useState(null);
            const [filmId, setFilmId] = useState('FILM_ID');
            const [fps, setFps] = useState('24');
            const [handles, setHandles] = useState(10);
            const [binData, setBinData] = useState(null);
            const [status, setStatus] = useState('');
            const [edlDragActive, setEdlDragActive] = useState(false);
            const [binDragActive, setBinDragActive] = useState(false);

            const parseEDL = (edlText) => {
                const lines = edlText.split('\n');
                const edlData = { edl_metadata: { edl_title: '', edl_fcm: '' }, events: [] };
                let lastEvent = null, lastScene = 0, vfxCounter = 0;
                const edlLineRegex = /^(\d+)\s+(\w+)\s+(\w+)\s+(\w+)\s+(\d{2}:\d{2}:\d{2}:\d{2})\s+(\d{2}:\d{2}:\d{2}:\d{2})\s+(\d{2}:\d{2}:\d{2}:\d{2})\s+(\d{2}:\d{2}:\d{2}:\d{2})$/;

                for (let line of lines) {
                    line = line.trim();
                    if (!line) continue;
                    if (line.startsWith('TITLE:')) edlData.edl_metadata.edl_title = line.substring(6).trim();
                    else if (line.startsWith('FCM:')) edlData.edl_metadata.edl_fcm = line.substring(4).trim();
                    else if (edlLineRegex.test(line)) {
                        const m = line.match(edlLineRegex);
                        lastEvent = { type: 'event', event_number: m[1], reel: m[2], track: m[3], transition: m[4], source_start_TC: m[5], source_end_TC: m[6], record_start_TC: m[7], record_end_TC: m[8], FROM: '', LOC: '', SOURCE: '', 'VFX ID': '' };
                        edlData.events.push(lastEvent);
                    } else if (line.startsWith('*FROM') && lastEvent) lastEvent.FROM = line.substring(5).trim();
                    else if (line.startsWith('*LOC:') && lastEvent) {
                        const loc = line.substring(5).trim();
                        lastEvent.LOC = loc;
                        lastEvent['VFX ID'] = loc.split(/\s+/).pop();
                    } else if (line.startsWith('*SOURCE') && lastEvent) {
                        lastEvent.SOURCE = line.substring(7).trim();
                        if (!lastEvent.LOC && !lastEvent['VFX ID']) {
                            const match = lastEvent.FROM.match(/\d+/);
                            if (match) {
                                const scene = match[0].padStart(3, '0');
                                vfxCounter = (scene === lastScene) ? vfxCounter + 10 : 10;
                                lastEvent['VFX ID'] = `${filmId}_${scene}_${String(vfxCounter).padStart(3, '0')}`;
                                lastScene = scene;
                            }
                        }
                    }
                }
                return edlData;
            };

            const parseTimecode = (tc, fr) => { const [h,m,s,f] = tc.split(':').map(Number); return h*3600*fr + m*60*fr + s*fr + f; };
            const framesToTimecode = (tf, fr) => {
                const h = Math.floor(tf / (3600*fr)); tf %= (3600*fr);
                const m = Math.floor(tf / (60*fr)); tf %= (60*fr);
                const s = Math.floor(tf / fr); const f = tf % fr;
                return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}:${String(f).padStart(2,'0')}`;
            };
            const addTimecode = (tc, fa, fr) => framesToTimecode(parseTimecode(tc, fr) + fa, fr);
            const subtractTimecode = (tc, fs, fr) => framesToTimecode(Math.max(0, parseTimecode(tc, fr) - fs), fr);

            const processEDLFile = (file) => {
                const ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
                if (!['.edl', '.txt'].includes(ext)) { setStatus('Error: Invalid file type. Please upload an EDL file (.edl)'); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const parsed = parseEDL(e.target.result);
                    const fname = file.name.replace(/\.[^/.]+$/, '');
                    parsed.edl_metadata.edl_filename = fname;
                    if (!parsed.edl_metadata.edl_title?.trim()) parsed.edl_metadata.edl_title = fname;
                    setEdlData(parsed);
                    setStatus(`EDL loaded: ${parsed.events.length} events found`);
                };
                reader.readAsText(file);
            };

            const processBinFile = (file) => {
                const ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
                if (!['.txt', '.tab'].includes(ext)) { setStatus('Error: Invalid file type. Please upload an AVID Bin file (.txt or .tab)'); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const lines = e.target.result.split('\n');
                    const headers = lines[0].split('\t');
                    const nameIdx = headers.indexOf('Name');
                    const data = lines.slice(1).filter(l => l.trim()).map(l => ({ Name: l.split('\t')[nameIdx] || '' }));
                    setBinData(data);
                    setStatus(`AVID Bin file loaded: ${data.length} entries found`);
                };
                reader.readAsText(file);
            };

            const downloadFile = (content, filename) => {
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
                setStatus(`Downloaded: ${filename}`);
            };

            const exportMarkers = () => {
                if (!edlData) return;
                const bn = edlData.edl_metadata.edl_filename || 'output';
                downloadFile(edlData.events.map(e => `vfx\t${e.record_start_TC}\tV1\tgreen\t${e['VFX ID']}\t1`).join('\n'), `${bn}_markers.txt`);
            };

            const exportSubcaps = () => {
                if (!edlData) return;
                const bn = edlData.edl_metadata.edl_filename || 'output';
                const content = '<begin subtitles>\n' + edlData.events.map(e => `${e.record_start_TC} ${e.record_end_TC}\n${e['VFX ID']}\n`).join('\n') + '<end subtitles>\n';
                downloadFile(content, `${bn}_subcaps.txt`);
            };

            const exportALEPulls = () => {
                if (!edlData) return;
                const fr = parseInt(fps), bn = edlData.edl_metadata.edl_filename || 'output';
                let content = `Heading\nFIELD_DELIM\tTABS\nVIDEO_FORMAT\t1080\nAUDIO_FORMAT\t48khz\nFPS\t${fps}\n\nColumn\nName\tTracks\tStart\tEnd\tTape\nData\n\n`;
                edlData.events.forEach(e => {
                    content += `${e['VFX ID']}\tV\t${subtractTimecode(e.source_start_TC, handles, fr)}\t${addTimecode(e.source_end_TC, handles, fr)}\t${e.reel}\n`;
                });
                downloadFile(content, `${bn}.ALE`);
            };

            const exportPullsEDL = () => {
                if (!edlData) return;
                const bn = edlData.edl_metadata.edl_filename || 'output';
                const content = `TITLE: ${bn}_pulls\nFCM: NON-DROP FRAME\n` + edlData.events.map(e => `${e.event_number} ${e['VFX ID']} ${e.track} ${e.transition} ${e.source_start_TC} ${e.source_end_TC} ${e.record_start_TC} ${e.record_end_TC}`).join('\n');
                downloadFile(content, `${bn}_pulls.edl`);
            };

            const exportGoogleTab = () => {
                if (!edlData) return;
                const fr = parseInt(fps), bn = edlData.edl_metadata.edl_filename || 'output';
                let content = '#\tName\tFrame\tComments\tStatus\tDate\tDuration\tStart\tEnd\tFrame Count Duration\tTape\n';
                edlData.events.forEach((e, i) => {
                    const sf = parseTimecode(e.source_start_TC, fr), ef = parseTimecode(e.source_end_TC, fr), df = ef - sf;
                    content += `${i+1}\t${e['VFX ID']}\t\t\t\t\t${framesToTimecode(df, fr)}\t${e.source_start_TC}\t${e.source_end_TC}\t${df}\t${e.reel}\n`;
                });
                downloadFile(content, `${bn}_TAB.txt`);
            };

            const exportFinalVFXEDL = () => {
                if (!edlData || !binData) { setStatus('Error: Please upload both EDL and AVID Bin files'); return; }
                const bn = edlData.edl_metadata.edl_filename || 'output';
                let content = `TITLE: ${bn}_vfx_final\nFCM: NON-DROP FRAME\n`;
                binData.forEach(b => edlData.events.forEach(e => {
                    if (b.Name.includes(e['VFX ID'])) content += `${e.event_number} ${b.Name} ${e.track} ${e.transition} ${e.source_start_TC} ${e.source_end_TC} ${e.record_start_TC} ${e.record_end_TC}\n`;
                }));
                downloadFile(content, `${bn}_vfx_final.edl`);
            };

            const handleDrag = (e, setter, val) => { e.preventDefault(); e.stopPropagation(); setter(val); };
            const handleDrop = (e, processor, setter) => { e.preventDefault(); e.stopPropagation(); setter(false); if (e.dataTransfer.files?.[0]) processor(e.dataTransfer.files[0]); };

            const Icon = ({ path }) => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={path} /></svg>;

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded shadow-sm p-6 border border-gray-200">
                            <div className="pb-5 mb-6 border-b border-gray-200">
                                <h1 className="text-2xl font-semibold text-gray-900 mb-4">VFX Turnover Tool</h1>
                                <div className="flex gap-2">
                                    {['main', 'info', 'help'].map(p => (
                                        <button key={p} onClick={() => setCurrentPage(p)} className={`px-4 py-2 text-sm rounded transition ${currentPage === p ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                            {p.charAt(0).toUpperCase() + p.slice(1)}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {currentPage === 'main' && (
                                <>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                        {[['Film ID', filmId, setFilmId, 'text'], ['FPS', fps, setFps, 'text'], ['Handles', handles, setHandles, 'number']].map(([label, val, setter, type]) => (
                                            <div key={label}>
                                                <label className="block text-xs font-medium text-gray-500 mb-1 uppercase">{label}</label>
                                                <input type={type} value={val} onChange={(e) => setter(type === 'number' ? parseInt(e.target.value) : e.target.value)} className="w-full px-3 py-2 bg-white border border-gray-300 rounded text-sm focus:outline-none focus:border-gray-900" />
                                            </div>
                                        ))}
                                    </div>

                                    <div className="mb-6">
                                        <div onDragEnter={(e) => handleDrag(e, setEdlDragActive, true)} onDragLeave={(e) => handleDrag(e, setEdlDragActive, false)} onDragOver={(e) => e.preventDefault()} onDrop={(e) => handleDrop(e, processEDLFile, setEdlDragActive)} className={`bg-gray-50 border-2 border-dashed rounded p-6 text-center cursor-pointer transition ${edlDragActive ? 'border-gray-900 bg-gray-100' : 'border-gray-300 hover:border-gray-400'}`}>
                                            <label className="cursor-pointer block">
                                                <div className="text-gray-400 mb-2 flex justify-center"><Icon path="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></div>
                                                <span className="text-sm font-medium text-gray-700">{edlDragActive ? 'Drop EDL file here' : 'Drag & drop EDL file or click to browse'}</span>
                                                <div className="text-xs text-gray-500 mt-1">.edl, .txt</div>
                                                {edlData && <div className="mt-2 text-xs text-gray-600">✓ {edlData.events.length} events loaded</div>}
                                                <input type="file" accept=".edl,.txt" onChange={(e) => e.target.files[0] && processEDLFile(e.target.files[0])} className="hidden" />
                                            </label>
                                        </div>
                                    </div>

                                    <div className="mb-6">
                                        <h2 className="text-xs font-medium text-gray-500 mb-3 uppercase">Export Options</h2>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                            {[['Markers', exportMarkers], ['Subcaps', exportSubcaps], ['ALE Pulls', exportALEPulls], ['Pulls EDL', exportPullsEDL], ['Google Tab', exportGoogleTab]].map(([name, fn]) => (
                                                <button key={name} onClick={fn} disabled={!edlData} className="px-3 py-2 bg-gray-900 hover:bg-gray-700 disabled:bg-gray-300 text-white rounded text-sm transition">{name}</button>
                                            ))}
                                        </div>
                                    </div>

                                    {status && <div className={`border rounded p-3 text-sm mb-6 ${status.startsWith('Error') ? 'bg-red-50 border-red-300 text-red-700' : 'bg-gray-100 border-gray-300 text-gray-700'}`}>{status}</div>}

                                    {edlData && (
                                        <div className="bg-gray-50 border border-gray-200 rounded p-4 mb-6">
                                            <h3 className="text-xs font-medium text-gray-500 mb-3 uppercase">Preview</h3>
                                            <div className="text-sm text-gray-700 space-y-1 mb-4">
                                                <p><span className="font-medium">Filename:</span> {edlData.edl_metadata.edl_filename}.edl</p>
                                                <p><span className="font-medium">Events:</span> {edlData.events.length}</p>
                                            </div>
                                            <div className="overflow-x-auto max-h-96 overflow-y-auto border border-gray-200 rounded">
                                                <table className="w-full text-xs">
                                                    <thead className="bg-gray-100 text-gray-600 uppercase sticky top-0">
                                                        <tr>{['#', 'VFX ID', 'Reel', 'Source In', 'Source Out', 'Record In', 'Record Out'].map(h => <th key={h} className="px-3 py-2 text-left">{h}</th>)}</tr>
                                                    </thead>
                                                    <tbody className="text-gray-700">
                                                        {edlData.events.map((e, i) => (
                                                            <tr key={i} className="border-b border-gray-200">
                                                                <td className="px-3 py-2">{e.event_number}</td>
                                                                <td className={`px-3 py-2 font-mono ${e.LOC ? 'text-green-600 font-semibold' : ''}`}>{e['VFX ID']}</td>
                                                                <td className="px-3 py-2">{e.reel}</td>
                                                                <td className="px-3 py-2 font-mono">{e.source_start_TC}</td>
                                                                <td className="px-3 py-2 font-mono">{e.source_end_TC}</td>
                                                                <td className="px-3 py-2 font-mono">{e.record_start_TC}</td>
                                                                <td className="px-3 py-2 font-mono">{e.record_end_TC}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}

                                    <div className="pt-6 border-t border-gray-200">
                                        <h2 className="text-xs font-medium text-gray-500 mb-3 uppercase">Incoming VFX EDL</h2>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                            <div onDragEnter={(e) => handleDrag(e, setBinDragActive, true)} onDragLeave={(e) => handleDrag(e, setBinDragActive, false)} onDragOver={(e) => e.preventDefault()} onDrop={(e) => handleDrop(e, processBinFile, setBinDragActive)} className={`bg-gray-50 border-2 border-dashed rounded p-4 text-center cursor-pointer transition ${binDragActive ? 'border-gray-900 bg-gray-100' : 'border-gray-300 hover:border-gray-400'}`}>
                                                <label className="cursor-pointer block">
                                                    <div className="text-gray-400 mb-1 flex justify-center"><Icon path="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></div>
                                                    <span className="text-sm font-medium text-gray-700">{binDragActive ? 'Drop AVID Bin file here' : 'Upload AVID Bin File'}</span>
                                                    <div className="text-xs text-gray-500 mt-1">.txt, .tab</div>
                                                    {binData && <div className="mt-2 text-xs text-gray-600">✓ {binData.length} entries loaded</div>}
                                                    <input type="file" accept=".txt,.tab" onChange={(e) => e.target.files[0] && processBinFile(e.target.files[0])} className="hidden" />
                                                </label>
                                            </div>
                                            <button onClick={exportFinalVFXEDL} disabled={!edlData || !binData} className="px-4 py-3 bg-gray-900 hover:bg-gray-700 disabled:bg-gray-300 text-white rounded text-sm font-medium transition h-full">Export Incoming VFX EDL</button>
                                        </div>
                                    </div>
                                </>
                            )}

                            {currentPage === 'info' && (
                                <div className="max-w-none text-sm text-gray-700 space-y-4">
                                    <h2 className="text-xl font-semibold text-gray-900">About</h2>
                                    <p>The VFX Turnover Tool streamlines VFX sequence preparation for post-production. It processes EDL files and generates multiple output formats for VFX production.</p>
                                    <h3 className="text-base font-semibold text-gray-900 mt-6">Features</h3>
                                    <ul className="list-disc pl-5 space-y-1">
                                        <li>Automatic VFX ID generation based on scene numbers</li>
                                        <li>Support for existing markers (LOC lines)</li>
                                        <li>Multiple export formats</li>
                                        <li>Timecode calculations with customizable FPS and handles</li>
                                        <li>Drag-and-drop file upload</li>
                                    </ul>
                                    <h3 className="text-base font-semibold text-gray-900 mt-6">VFX ID Format</h3>
                                    <p>Format: <code className="bg-gray-100 px-2 py-1 rounded">FILM_ID_SCENE_SHOT</code> (e.g., FILM_ID_001_010)</p>
                                    <h3 className="text-base font-semibold text-gray-900 mt-6">Supported Files</h3>
                                    <p><strong>EDL:</strong> .edl, .txt | <strong>Bin:</strong> .txt, .tab</p>
                                    <h3 className="text-base font-semibold text-gray-900 mt-6">Contact</h3>
                                    <p><a href="mailto:pnardese@gmail.com">pnardese@gmail.com</a></p>
                                </div>
                            )}

                            {currentPage === 'help' && (
                                <div className="max-w-none text-sm text-gray-700 space-y-6">
                                    <h2 className="text-xl font-semibold text-gray-900">How to Use</h2>
                                    <div>
                                        <h3 className="text-base font-semibold text-gray-900 mb-2">1. Configure Settings</h3>
                                        <ul className="list-disc pl-5 space-y-1">
                                            <li><strong>Film ID:</strong> Project identifier</li>
                                            <li><strong>FPS:</strong> Frame rate (default: 24)</li>
                                            <li><strong>Handles:</strong> Extra frames (default: 10)</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h3 className="text-base font-semibold text-gray-900 mb-2">2. Upload EDL</h3>
                                        <p>Drag & drop or click to browse. Green VFX IDs = existing markers, Gray = auto-generated.</p>
                                    </div>
                                    <div>
                                        <h3 className="text-base font-semibold text-gray-900 mb-2">3. Export Files</h3>
                                        <ul className="list-disc pl-5 space-y-1">
                                            <li><strong>Markers:</strong> Timeline markers</li>
                                            <li><strong>Subcaps:</strong> Subtitle format</li>
                                            <li><strong>ALE Pulls:</strong> Avid Log Exchange with handles</li>
                                            <li><strong>Pulls EDL:</strong> VFX EDL format</li>
                                            <li><strong>Google Tab:</strong> Spreadsheet import</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h3 className="text-base font-semibold text-gray-900 mb-2">4. Final VFX EDL</h3>
                                        <p>Upload AVID Bin file (.txt/.tab) with rendered clip names, then export final EDL.</p>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<VFXTurnoverApp />, document.getElementById('root'));
    </script>
</body>
</html>