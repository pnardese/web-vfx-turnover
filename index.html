<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VFX Turnover Tool v0.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const VFXTurnoverApp = () => {
            const [currentPage, setCurrentPage] = useState('main');
            const [edlData, setEdlData] = useState(() => { try { return JSON.parse(localStorage.getItem('vfx_edlData')); } catch { return null; } });
            const [edlFilePath, setEdlFilePath] = useState(() => localStorage.getItem('vfx_edlFilePath') || '');
            const [filmId, setFilmId] = useState(() => localStorage.getItem('vfx_filmId') || 'FILM_ID');
            const [fps, setFps] = useState(() => localStorage.getItem('vfx_fps') || '24');
            const [handles, setHandles] = useState(() => { const v = parseInt(localStorage.getItem('vfx_handles')); return isNaN(v) ? 10 : v; });
            const [binData, setBinData] = useState(() => { try { return JSON.parse(localStorage.getItem('vfx_binData')); } catch { return null; } });
            const [binFilePath, setBinFilePath] = useState(() => localStorage.getItem('vfx_binFilePath') || '');
            const [status, setStatus] = useState('');
            const [edlDragActive, setEdlDragActive] = useState(false);
            const [binDragActive, setBinDragActive] = useState(false);
            const [markerUser, setMarkerUser] = useState(() => localStorage.getItem('vfx_markerUser') || 'VFX');
            const [markerTrack, setMarkerTrack] = useState(() => localStorage.getItem('vfx_markerTrack') || 'V1');
            const [markerColor, setMarkerColor] = useState(() => localStorage.getItem('vfx_markerColor') || 'green');
            const [markerPosition, setMarkerPosition] = useState(() => localStorage.getItem('vfx_markerPosition') || 'start');

            useEffect(() => { localStorage.setItem('vfx_filmId', filmId); }, [filmId]);
            useEffect(() => { localStorage.setItem('vfx_fps', fps); }, [fps]);
            useEffect(() => { if (!isNaN(handles)) localStorage.setItem('vfx_handles', handles); }, [handles]);
            useEffect(() => { localStorage.setItem('vfx_markerUser', markerUser); }, [markerUser]);
            useEffect(() => { localStorage.setItem('vfx_markerTrack', markerTrack); }, [markerTrack]);
            useEffect(() => { localStorage.setItem('vfx_markerColor', markerColor); }, [markerColor]);
            useEffect(() => { localStorage.setItem('vfx_markerPosition', markerPosition); }, [markerPosition]);
            useEffect(() => { if (edlData) localStorage.setItem('vfx_edlData', JSON.stringify(edlData)); else localStorage.removeItem('vfx_edlData'); }, [edlData]);
            useEffect(() => { localStorage.setItem('vfx_edlFilePath', edlFilePath); }, [edlFilePath]);
            useEffect(() => { if (binData) localStorage.setItem('vfx_binData', JSON.stringify(binData)); else localStorage.removeItem('vfx_binData'); }, [binData]);
            useEffect(() => { localStorage.setItem('vfx_binFilePath', binFilePath); }, [binFilePath]);

            const parseEDL = (edlText) => {
                const lines = edlText.split('\n');
                const edlData = { edl_metadata: { edl_title: '', edl_fcm: '' }, events: [] };
                let lastEvent = null, lastScene = 0, vfxCounter = 0;
                const edlLineRegex = /^(\d+)\s+(\w+)\s+(\w+)\s+(\w+)\s+(\d{2}:\d{2}:\d{2}:\d{2})\s+(\d{2}:\d{2}:\d{2}:\d{2})\s+(\d{2}:\d{2}:\d{2}:\d{2})\s+(\d{2}:\d{2}:\d{2}:\d{2})$/;

                for (let line of lines) {
                    line = line.trim();
                    if (!line) continue;
                    if (line.startsWith('TITLE:')) edlData.edl_metadata.edl_title = line.substring(6).trim();
                    else if (line.startsWith('FCM:')) edlData.edl_metadata.edl_fcm = line.substring(4).trim();
                    else if (edlLineRegex.test(line)) {
                        const m = line.match(edlLineRegex);
                        lastEvent = { type: 'event', event_number: m[1], reel: m[2], track: m[3], transition: m[4], source_start_TC: m[5], source_end_TC: m[6], record_start_TC: m[7], record_end_TC: m[8], FROM: '', LOC: '', SOURCE: '', 'VFX ID': '' };
                        edlData.events.push(lastEvent);
                    } else if ((line.startsWith('*FROM') || line.startsWith('* FROM')) && lastEvent) {
                        const fromIndex = line.indexOf('FROM');
                        lastEvent.FROM = line.substring(fromIndex + 4).trim();
                    }
                    else if ((line.startsWith('*LOC:') || line.startsWith('* LOC:')) && lastEvent) {
                        const locIndex = line.indexOf('LOC:');
                        const loc = line.substring(locIndex + 4).trim();
                        lastEvent.LOC = loc;
                        lastEvent['VFX ID'] = loc.split(/\s+/).pop();
                    } else if ((line.startsWith('*SOURCE') || line.startsWith('* SOURCE')) && lastEvent) {
                        const sourceIndex = line.indexOf('SOURCE');
                        let sourceValue = line.substring(sourceIndex + 6).trim();
                        // Strip "FILE:" prefix if present (CMX 3600 format)
                        if (sourceValue.toUpperCase().startsWith('FILE:')) {
                            sourceValue = sourceValue.substring(5).trim();
                        }
                        lastEvent.SOURCE = sourceValue;
                        // For CMX 3600: if SOURCE has full filename and reel is truncated, use SOURCE as reel
                        if (sourceValue && sourceValue.length > lastEvent.reel.length) {
                            lastEvent.reel = sourceValue;
                        }
                        if (!lastEvent.LOC && !lastEvent['VFX ID']) {
                            const match = lastEvent.FROM.match(/\d+/);
                            if (match) {
                                const scene = match[0].padStart(3, '0');
                                vfxCounter = (scene === lastScene) ? vfxCounter + 10 : 10;
                                lastEvent['VFX ID'] = `${filmId}_${scene}_${String(vfxCounter).padStart(3, '0')}`;
                                lastScene = scene;
                            }
                        }
                    }
                }
                return edlData;
            };

            const parseTimecode = (tc, fr) => { const [h,m,s,f] = tc.split(':').map(Number); return h*3600*fr + m*60*fr + s*fr + f; };
            const framesToTimecode = (tf, fr) => {
                const h = Math.floor(tf / (3600*fr)); tf %= (3600*fr);
                const m = Math.floor(tf / (60*fr)); tf %= (60*fr);
                const s = Math.floor(tf / fr); const f = tf % fr;
                return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}:${String(f).padStart(2,'0')}`;
            };
            const addTimecode = (tc, fa, fr) => framesToTimecode(parseTimecode(tc, fr) + fa, fr);
            const subtractTimecode = (tc, fs, fr) => framesToTimecode(Math.max(0, parseTimecode(tc, fr) - fs), fr);

            const processEDLFile = (file) => {
                const ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
                if (ext !== '.edl') { setStatus('Error: Invalid file type. Please upload an EDL file (.edl)'); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const parsed = parseEDL(e.target.result);
                    const fname = file.name.replace(/\.[^/.]+$/, '');
                    parsed.edl_metadata.edl_filename = fname;
                    if (!parsed.edl_metadata.edl_title?.trim()) parsed.edl_metadata.edl_title = fname;

                    // Compare with cached EDL data
                    const cachedEdl = edlData;
                    let newCount = 0, removedCount = 0;

                    if (cachedEdl && cachedEdl.events) {
                        const cachedVfxIds = new Set(cachedEdl.events.filter(e => e.changeStatus !== 'removed').map(e => e['VFX ID']));
                        const newVfxIds = new Set(parsed.events.map(e => e['VFX ID']));

                        // Mark new events
                        parsed.events.forEach(e => {
                            if (!cachedVfxIds.has(e['VFX ID'])) {
                                e.changeStatus = 'new';
                                newCount++;
                            } else {
                                e.changeStatus = 'unchanged';
                            }
                        });

                        // Add removed events from cache
                        cachedEdl.events.filter(e => e.changeStatus !== 'removed').forEach(cachedEvent => {
                            if (!newVfxIds.has(cachedEvent['VFX ID'])) {
                                parsed.events.push({ ...cachedEvent, changeStatus: 'removed' });
                                removedCount++;
                            }
                        });
                    }

                    setEdlData(parsed);
                    setEdlFilePath(file.name);
                    const statusParts = [`EDL loaded: ${parsed.events.filter(e => e.changeStatus !== 'removed').length} events`];
                    if (newCount > 0) statusParts.push(`${newCount} new`);
                    if (removedCount > 0) statusParts.push(`${removedCount} removed`);
                    setStatus(statusParts.join(', '));
                };
                reader.readAsText(file);
            };

            const clearEdlData = () => {
                setEdlData(null);
                setEdlFilePath('');
                setStatus('EDL data cleared');
            };

            const processBinFile = (file) => {
                const ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
                if (ext !== '.txt') { setStatus('Error: Invalid file type. Please upload an AVID Bin file (.txt)'); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const lines = e.target.result.split(/\r\n|\r|\n/);
                    const headers = lines[0].split('\t');
                    const nameIdx = headers.indexOf('Name');
                    const startIdx = headers.indexOf('Start');
                    const endIdx = headers.indexOf('End');
                    const data = lines.slice(1).filter(l => l.trim()).map(l => {
                        const cols = l.split('\t');
                        return { Name: cols[nameIdx] || '', Start: cols[startIdx] || '', End: cols[endIdx] || '' };
                    });
                    setBinData(data);
                    setBinFilePath(file.name);
                    setStatus(`AVID Bin file loaded: ${data.length} entries found`);
                };
                reader.readAsText(file);
            };

            const clearBinData = () => {
                setBinData(null);
                setBinFilePath('');
                setStatus('AVID Bin data cleared');
            };

            const downloadFile = (content, filename) => {
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
                setStatus(`Downloaded: ${filename}`);
            };

            const getActiveEvents = () => edlData?.events.filter(e => e.changeStatus !== 'removed') || [];

            const exportMarkers = () => {
                if (!edlData) return;
                const bn = edlData.edl_metadata.edl_filename || 'output';
                const fr = parseInt(fps);
                downloadFile(getActiveEvents().map(e => {
                    let tc = e.record_start_TC;
                    if (markerPosition === 'middle') {
                        const startFrames = parseTimecode(e.record_start_TC, fr);
                        const endFrames = parseTimecode(e.record_end_TC, fr);
                        tc = framesToTimecode(Math.floor((startFrames + endFrames) / 2), fr);
                    }
                    return `${markerUser}\t${tc}\t${markerTrack}\t${markerColor}\t${e['VFX ID']}\t1`;
                }).join('\n'), `${bn}_markers.txt`);
            };

            const exportSubcaps = () => {
                if (!edlData) return;
                const bn = edlData.edl_metadata.edl_filename || 'output';
                const content = '<begin subtitles>\n' + getActiveEvents().map(e => `${e.record_start_TC} ${e.record_end_TC}\n${e['VFX ID']}\n`).join('\n') + '\n<end subtitles>\n';
                downloadFile(content, `${bn}_subcaps.txt`);
            };

            const exportALEPulls = () => {
                if (!edlData) return;
                const fr = parseInt(fps), bn = edlData.edl_metadata.edl_filename || 'output';
                let content = `Heading\nFIELD_DELIM\tTABS\nVIDEO_FORMAT\t1080\nAUDIO_FORMAT\t48khz\nFPS\t${fps}\n\nColumn\nName\tTracks\tStart\tEnd\tTape\nData\n\n`;
                getActiveEvents().forEach(e => {
                    content += `${e['VFX ID']}\tV\t${subtractTimecode(e.source_start_TC, handles, fr)}\t${addTimecode(e.source_end_TC, handles, fr)}\t${e.reel}\n`;
                });
                downloadFile(content, `${bn}.ALE`);
            };

            const exportPullsEDL = () => {
                if (!edlData) return;
                const bn = edlData.edl_metadata.edl_filename || 'output';
                const content = `TITLE: ${bn}_pulls\nFCM: NON-DROP FRAME\n` + getActiveEvents().map(e => `${e.event_number} ${e['VFX ID']} ${e.track} ${e.transition} ${e.source_start_TC} ${e.source_end_TC} ${e.record_start_TC} ${e.record_end_TC}`).join('\n');
                downloadFile(content, `${bn}_pulls.edl`);
            };

            const exportGoogleTab = () => {
                if (!edlData) return;
                const fr = parseInt(fps), bn = edlData.edl_metadata.edl_filename || 'output';
                let content = '#\tName\tFrame\tComments\tStatus\tDate\tDuration\tStart\tEnd\tFrame Count Duration\tTape\n';
                getActiveEvents().forEach((e, i) => {
                    const sf = parseTimecode(e.source_start_TC, fr), ef = parseTimecode(e.source_end_TC, fr), df = ef - sf;
                    content += `${i+1}\t${e['VFX ID']}\t\t\t\t\t${framesToTimecode(df, fr)}\t${e.source_start_TC}\t${e.source_end_TC}\t${df}\t${e.reel}\n`;
                });
                downloadFile(content, `${bn}_TAB.txt`);
            };

            const exportFinalVFXEDL = () => {
                if (!edlData || !binData) { setStatus('Error: Please upload both EDL and AVID Bin files'); return; }
                const bn = edlData.edl_metadata.edl_filename || 'output';
                let content = `TITLE: ${bn}_incoming\nFCM: NON-DROP FRAME\n`;
                const activeEvents = getActiveEvents();
                binData.forEach(b => activeEvents.forEach(e => {
                    if (b.Start === e.source_start_TC && b.End === e.source_end_TC) content += `${e.event_number} ${b.Name} ${e.track} ${e.transition} ${e.source_start_TC} ${e.source_end_TC} ${e.record_start_TC} ${e.record_end_TC}\n`;
                }));
                downloadFile(content, `${bn}_incoming.edl`);
            };

            const handleDrag = (e, setter, val) => { e.preventDefault(); e.stopPropagation(); setter(val); };
            const handleDrop = (e, processor, setter) => { e.preventDefault(); e.stopPropagation(); setter(false); if (e.dataTransfer.files?.[0]) processor(e.dataTransfer.files[0]); };

            const Icon = ({ path }) => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={path} /></svg>;

            return (
                <div className="min-h-screen bg-[#0a0f14] p-6">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-[#0d1318] rounded-xl p-6 border border-[#1a2530]">
                            <div className="pb-5 mb-6 border-b border-[#1a2530]">
                                <h1 className="text-2xl font-semibold text-white mb-4">VFX Turnover Tool v0.1</h1>
                                <div className="flex gap-2">
                                    {['main', 'info', 'help'].map(p => (
                                        <button key={p} onClick={() => setCurrentPage(p)} className={`px-4 py-2 text-sm rounded-lg transition ${currentPage === p ? 'bg-[#14b8a6] text-[#0a0f14] font-medium' : 'bg-[#1a2530] text-gray-300 hover:bg-[#243040] border border-[#2a3545]'}`}>
                                            {p.charAt(0).toUpperCase() + p.slice(1)}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {currentPage === 'main' && (
                                <>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                        {[['Film ID', filmId, setFilmId, 'text'], ['FPS', fps, setFps, 'text'], ['Handles', handles, setHandles, 'number']].map(([label, val, setter, type]) => (
                                            <div key={label}>
                                                <label className="block text-xs font-medium text-[#14b8a6] mb-1 uppercase">{label}</label>
                                                <input type={type} value={val} onChange={(e) => setter(type === 'number' ? parseInt(e.target.value) : e.target.value)} className="w-full px-3 py-2 bg-[#0a0f14] border border-[#2a3545] rounded-lg text-sm text-white focus:outline-none focus:border-[#14b8a6]" />
                                            </div>
                                        ))}
                                    </div>

                                    {status && <div className={`border rounded-lg p-3 text-sm mb-6 ${status.startsWith('Error') ? 'bg-red-900/20 border-red-800 text-red-400' : 'bg-[#14b8a6]/10 border-[#14b8a6]/30 text-[#14b8a6]'}`}>{status}</div>}

                                    <div className="mb-6">
                                        <div className="flex gap-2 items-stretch">
                                            <div onDragEnter={(e) => handleDrag(e, setEdlDragActive, true)} onDragLeave={(e) => handleDrag(e, setEdlDragActive, false)} onDragOver={(e) => e.preventDefault()} onDrop={(e) => handleDrop(e, processEDLFile, setEdlDragActive)} className={`flex-1 bg-[#0a0f14] border-2 border-dashed rounded-xl p-6 text-center cursor-pointer transition ${edlDragActive ? 'border-[#14b8a6] bg-[#14b8a6]/10' : 'border-[#2a3545] hover:border-[#14b8a6]/50'}`}>
                                                <label className="cursor-pointer block">
                                                    <div className="text-[#14b8a6] mb-2 flex justify-center"><Icon path="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></div>
                                                    <span className="text-sm font-medium text-gray-300">{edlDragActive ? 'Drop EDL file here' : 'Drag & drop EDL file or click to browse'}</span>
                                                    <div className="text-xs text-gray-500 mt-1">.edl</div>
                                                    {edlData && <div className="mt-2 text-xs text-[#14b8a6]">✓ {edlData.events.length} events loaded</div>}
                                                    {edlFilePath && <div className="mt-1 text-xs text-gray-400 break-all">{edlFilePath}</div>}
                                                    <input type="file" accept=".edl" onChange={(e) => e.target.files[0] && processEDLFile(e.target.files[0])} className="hidden" />
                                                </label>
                                            </div>
                                            {edlData && (
                                                <button onClick={clearEdlData} className="px-2 py-2 bg-red-900/30 hover:bg-red-900/50 border border-red-800 text-red-400 rounded-lg text-xs transition flex flex-col items-center self-center" title="Clear EDL">
                                                    <span>EDL Clear</span>
                                                    <svg className="w-4 h-4 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                </button>
                                            )}
                                        </div>
                                    </div>

                                    <div className="mb-6">
                                        <h2 className="text-xs font-medium text-[#14b8a6] mb-3 uppercase">Export Options</h2>
                                        <div className="grid grid-cols-2 md:grid-cols-5 gap-2 mb-2 items-end">
                                            <button onClick={exportMarkers} disabled={!edlData} className="px-3 py-2 bg-[#14b8a6] hover:bg-[#0d9488] disabled:bg-[#1a2530] disabled:text-gray-600 text-[#0a0f14] font-medium rounded-lg text-sm transition">Markers</button>
                                            <div>
                                                <label className="block text-xs text-gray-500 mb-1">User info</label>
                                                <input type="text" value={markerUser} onChange={(e) => setMarkerUser(e.target.value)} className="w-full px-2 py-2 bg-[#0a0f14] border border-[#2a3545] rounded-lg text-sm text-white focus:outline-none focus:border-[#14b8a6]" />
                                            </div>
                                            <div>
                                                <label className="block text-xs text-gray-500 mb-1">Position</label>
                                                <select value={markerPosition} onChange={(e) => setMarkerPosition(e.target.value)} className="w-full px-2 py-2 bg-[#0a0f14] border border-[#2a3545] rounded-lg text-sm text-white focus:outline-none focus:border-[#14b8a6]">
                                                    {[['start', 'Start'], ['middle', 'Middle']].map(([v, l]) => <option key={v} value={v}>{l}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs text-gray-500 mb-1">Track</label>
                                                <select value={markerTrack} onChange={(e) => setMarkerTrack(e.target.value)} className="w-full px-2 py-2 bg-[#0a0f14] border border-[#2a3545] rounded-lg text-sm text-white focus:outline-none focus:border-[#14b8a6]">
                                                    {['TC','V1','V2','V3','V4','V5','V6','V7','V8'].map(v => <option key={v} value={v}>{v}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs text-gray-500 mb-1">Color</label>
                                                <select value={markerColor} onChange={(e) => setMarkerColor(e.target.value)} className="w-full px-2 py-2 bg-[#0a0f14] border border-[#2a3545] rounded-lg text-sm text-white focus:outline-none focus:border-[#14b8a6]">
                                                    {['red','green','blue','cyan','magenta','yellow','black','white'].map(c => <option key={c} value={c}>{c.charAt(0).toUpperCase() + c.slice(1)}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                            {[['Subcaps', exportSubcaps], ['ALE Pulls', exportALEPulls], ['Pulls EDL', exportPullsEDL], ['Google Tab', exportGoogleTab]].map(([name, fn]) => (
                                                <button key={name} onClick={fn} disabled={!edlData} className="px-3 py-2 bg-[#14b8a6] hover:bg-[#0d9488] disabled:bg-[#1a2530] disabled:text-gray-600 text-[#0a0f14] font-medium rounded-lg text-sm transition">{name}</button>
                                            ))}
                                        </div>
                                    </div>

                                    {edlData && (
                                        <div className="bg-[#0a0f14] border border-[#1a2530] rounded-xl p-4 mb-6">
                                            <h3 className="text-xs font-medium text-[#14b8a6] mb-3 uppercase">Preview</h3>
                                            <div className="text-sm text-gray-300 space-y-1 mb-4">
                                                <p><span className="font-medium text-white">File:</span> {edlFilePath || `${edlData.edl_metadata.edl_filename}.edl`}</p>
                                                <p>
                                                    <span className="font-medium text-white">Events:</span> {edlData.events.filter(e => e.changeStatus !== 'removed').length}
                                                    {edlData.events.some(e => e.changeStatus === 'new') && <span className="ml-2 text-green-400">+{edlData.events.filter(e => e.changeStatus === 'new').length} new</span>}
                                                    {edlData.events.some(e => e.changeStatus === 'removed') && <span className="ml-2 text-red-400">-{edlData.events.filter(e => e.changeStatus === 'removed').length} removed</span>}
                                                </p>
                                            </div>
                                            <div className="overflow-x-auto max-h-96 overflow-y-auto border border-[#1a2530] rounded-lg">
                                                <table className="w-full text-xs">
                                                    <thead className="bg-[#1a2530] text-[#14b8a6] uppercase sticky top-0">
                                                        <tr>{['#', 'VFX ID', 'Reel', 'Source In', 'Source Out', 'Record In', 'Record Out'].map(h => <th key={h} className="px-3 py-2 text-left">{h}</th>)}</tr>
                                                    </thead>
                                                    <tbody className="text-gray-300">
                                                        {edlData.events.map((e, i) => (
                                                            <tr key={i} className={`border-b border-[#1a2530] hover:bg-[#1a2530]/50 ${e.changeStatus === 'new' ? 'bg-green-900/20' : e.changeStatus === 'removed' ? 'bg-red-900/20' : ''}`}>
                                                                <td className={`px-3 py-2 ${e.changeStatus === 'removed' ? 'text-red-400 line-through' : ''}`}>{e.event_number}</td>
                                                                <td className={`px-3 py-2 font-mono ${e.changeStatus === 'new' ? 'text-green-400 font-semibold' : e.changeStatus === 'removed' ? 'text-red-400 line-through' : e.LOC ? 'text-[#14b8a6] font-semibold' : ''}`}>{e['VFX ID']}</td>
                                                                <td className={`px-3 py-2 ${e.changeStatus === 'removed' ? 'text-red-400 line-through' : ''}`}>{e.reel}</td>
                                                                <td className={`px-3 py-2 font-mono ${e.changeStatus === 'removed' ? 'text-red-400 line-through' : ''}`}>{e.source_start_TC}</td>
                                                                <td className={`px-3 py-2 font-mono ${e.changeStatus === 'removed' ? 'text-red-400 line-through' : ''}`}>{e.source_end_TC}</td>
                                                                <td className={`px-3 py-2 font-mono ${e.changeStatus === 'removed' ? 'text-red-400 line-through' : ''}`}>{e.record_start_TC}</td>
                                                                <td className={`px-3 py-2 font-mono ${e.changeStatus === 'removed' ? 'text-red-400 line-through' : ''}`}>{e.record_end_TC}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}

                                    <div className="pt-6 border-t border-[#1a2530]">
                                        <h2 className="text-xs font-medium text-[#14b8a6] mb-3 uppercase">Incoming VFX EDL</h2>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch">
                                            <div className="flex gap-2 items-stretch">
                                                <div onDragEnter={(e) => handleDrag(e, setBinDragActive, true)} onDragLeave={(e) => handleDrag(e, setBinDragActive, false)} onDragOver={(e) => e.preventDefault()} onDrop={(e) => handleDrop(e, processBinFile, setBinDragActive)} className={`flex-1 bg-[#0a0f14] border-2 border-dashed rounded-xl p-4 text-center cursor-pointer transition ${binDragActive ? 'border-[#14b8a6] bg-[#14b8a6]/10' : 'border-[#2a3545] hover:border-[#14b8a6]/50'}`}>
                                                    <label className="cursor-pointer block">
                                                        <div className="text-[#14b8a6] mb-1 flex justify-center"><Icon path="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></div>
                                                        <span className="text-sm font-medium text-gray-300">{binDragActive ? 'Drop AVID Bin file here' : 'Drag & drop AVID Bin File or click to browse'}</span>
                                                        <div className="text-xs text-gray-500 mt-1">.txt</div>
                                                        {binData && <div className="mt-2 text-xs text-[#14b8a6]">✓ {binData.length} entries loaded</div>}
                                                        {binFilePath && <div className="mt-1 text-xs text-gray-400 break-all">{binFilePath}</div>}
                                                        <input type="file" accept=".txt" onChange={(e) => e.target.files[0] && processBinFile(e.target.files[0])} className="hidden" />
                                                    </label>
                                                </div>
                                                {binData && (
                                                    <button onClick={clearBinData} className="px-2 py-2 bg-red-900/30 hover:bg-red-900/50 border border-red-800 text-red-400 rounded-lg text-xs transition flex flex-col items-center self-center" title="Clear AVID Bin">
                                                        <span>AVID Bin Clear</span>
                                                        <svg className="w-4 h-4 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                    </button>
                                                )}
                                            </div>
                                            <button onClick={exportFinalVFXEDL} disabled={!edlData || !binData} className="px-4 py-3 bg-[#14b8a6] hover:bg-[#0d9488] disabled:bg-[#1a2530] disabled:text-gray-600 text-[#0a0f14] font-medium rounded-lg text-sm transition">Export Incoming VFX EDL</button>
                                        </div>
                                        {binData && (
                                            <div className="bg-[#0a0f14] border border-[#1a2530] rounded-xl p-4 mt-4">
                                                <h3 className="text-xs font-medium text-[#14b8a6] mb-3 uppercase">Incoming VFX Preview</h3>
                                                <div className="text-sm text-gray-300 space-y-1 mb-4">
                                                    {binFilePath && <p><span className="font-medium text-white">File:</span> {binFilePath}</p>}
                                                    <p><span className="font-medium text-white">Entries:</span> {binData.length}</p>
                                                </div>
                                                <div className="overflow-x-auto max-h-64 overflow-y-auto border border-[#1a2530] rounded-lg">
                                                    <table className="w-full text-xs">
                                                        <thead className="bg-[#1a2530] text-[#14b8a6] uppercase sticky top-0">
                                                            <tr>{['#', 'Name', 'Start', 'End'].map(h => <th key={h} className="px-3 py-2 text-left">{h}</th>)}</tr>
                                                        </thead>
                                                        <tbody className="text-gray-300">
                                                            {binData.map((b, i) => (
                                                                <tr key={i} className="border-b border-[#1a2530] hover:bg-[#1a2530]/50">
                                                                    <td className="px-3 py-2">{i + 1}</td>
                                                                    <td className="px-3 py-2 font-mono">{b.Name}</td>
                                                                    <td className="px-3 py-2 font-mono">{b.Start}</td>
                                                                    <td className="px-3 py-2 font-mono">{b.End}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </>
                            )}

                            {currentPage === 'info' && (
                                <div className="max-w-none text-sm text-gray-300 space-y-4">
                                    <h2 className="text-xl font-semibold text-white">About</h2>
                                    <p>The VFX Turnover Tool v0.1 streamlines VFX sequence preparation for post-production. It processes EDL files and generates multiple output formats for VFX production.</p>
                                    <h3 className="text-base font-semibold text-[#14b8a6] mt-6">Features</h3>
                                    <ul className="list-disc pl-5 space-y-1">
                                        <li>Automatic VFX ID generation based on scene numbers</li>
                                        <li>Support for existing markers (LOC lines)</li>
                                        <li>Multiple export formats</li>
                                        <li>Timecode calculations with customizable FPS and handles</li>
                                        <li>Drag-and-drop file upload</li>
                                        <li>Marker position options - place markers at clip start or middle</li>
                                        <li>Persistent settings and file data - settings, loaded EDL and AVID Bin files are saved across browser sessions</li>
                                        <li>Clear buttons to easily remove loaded files</li>
                                        <li>Change tracking - new VFX IDs highlighted in green, removed ones in red</li>
                                    </ul>
                                    <h3 className="text-base font-semibold text-[#14b8a6] mt-6">VFX ID Format</h3>
                                    <p>Format: <code className="bg-[#1a2530] px-2 py-1 rounded text-[#14b8a6]">FILM_ID_SCENE_SHOT</code> (e.g., FILM_ID_001_010)</p>
                                    <h3 className="text-base font-semibold text-[#14b8a6] mt-6">Supported Files</h3>
                                    <p><strong className="text-white">EDL:</strong> .edl (File_129, CMX 3600) | <strong className="text-white">Bin:</strong> .txt</p>
                                    <h3 className="text-base font-semibold text-[#14b8a6] mt-6">Contact</h3>
                                    <p><a href="mailto:pnardese@gmail.com" className="text-[#14b8a6] hover:underline">pnardese@gmail.com</a></p>
                                </div>
                            )}

                            {currentPage === 'help' && (
                                <div className="max-w-none text-sm text-gray-300 space-y-6">
                                    <h2 className="text-xl font-semibold text-white">Help</h2>

                                    <div>
                                        <h3 className="text-base font-semibold text-[#14b8a6] mb-2">1. Create EDL from Avid</h3>
                                        <p className="mb-3">Create an EDL (File_129 or CMX3600) from the Avid video track containing only shots planned for VFX. In List Options in Avid, check: <strong className="text-white">Clip Names</strong>, <strong className="text-white">Source File Name</strong>, and <strong className="text-white">Markers</strong>.</p>
                                        <p className="mb-3">VFX IDs are created automatically based on the following rule: <code className="bg-[#1a2530] px-2 py-1 rounded text-[#14b8a6]">FILE_ID_Scene_num</code>, where num is a progressive number like 010, 020, 030, etc.</p>
                                        <p className="mb-3">Existing markers on timeline are imported into the tool as existing VFX IDs (you can find them in the EDL as *LOC/* LOC lines). Therefore, if you add VFX shots in Avid, you need to add markers with their new corresponding VFX IDs to re-import them correctly into the tool.</p>
                                        <img src="imgs/01_create_edl.png" alt="Configuration of the list tool in Avid Media Composer for EDL exporting" className="rounded-lg border border-gray-700 mt-2 max-w-full" />
                                        <p className="text-xs text-gray-500 mt-1">Configuration of the list tool in Avid Media Composer for EDL exporting.</p>
                                    </div>

                                    <div>
                                        <h3 className="text-base font-semibold text-[#14b8a6] mb-2">2. Export Markers and Subcaps</h3>
                                        <p>Export markers and subcaps and import them into Avid to help keep track of VFXs.</p>
                                    </div>

                                    <div>
                                        <h3 className="text-base font-semibold text-[#14b8a6] mb-2">3. Export Frames</h3>
                                        <p className="mb-3">Export markers from Avid as JPGs to use them to build a VFX Shots database.</p>
                                        <img src="imgs/02_export_frames.png" alt="Export settings for frame extraction at marker's position" className="rounded-lg border border-gray-700 mt-2 max-w-full" />
                                        <p className="text-xs text-gray-500 mt-1">Export settings for frame extraction at marker's position.</p>
                                    </div>

                                    <div>
                                        <h3 className="text-base font-semibold text-[#14b8a6] mb-2">4. Export TAB Text Files</h3>
                                        <p>Export TAB text files with VFX IDs info, that can be imported in any database/spreadsheet to build a VFX shot database.</p>
                                    </div>

                                    <div>
                                        <h3 className="text-base font-semibold text-[#14b8a6] mb-2">5. Export ALE Pulls</h3>
                                        <p className="mb-3">Export ALE Pulls to create pulls (subclips with VFX IDs as names from the master clips). After selecting master clips in bin, drag ALE file on bin. Import settings: <em className="text-white">Merge events with known sources and automatically create subclips</em></p>
                                        <img src="imgs/03_merge_events_ale.png" alt="Import settings" className="rounded-lg border border-gray-700 mt-2 max-w-full" />
                                        <p className="text-xs text-gray-500 mt-1">Import settings.</p>
                                    </div>

                                    <div>
                                        <h3 className="text-base font-semibold text-[#14b8a6] mb-2">6. Export Pulls EDL</h3>
                                        <p className="mb-3">Export Pulls EDL to create a timeline with the pull subclips. Import the EDL into Avid bin, relink to the pull subclips using Names.</p>
                                        <img src="imgs/04_relink_edl_pulls_v02.png" alt="Relink configuration" className="rounded-lg border border-gray-700 mt-2 max-w-full" />
                                        <p className="text-xs text-gray-500 mt-1">Relink configuration.</p>
                                    </div>

                                    <div>
                                        <h3 className="text-base font-semibold text-[#14b8a6] mb-2">7. VFX Cut-ins</h3>
                                        <p className="mb-3">When you receive incoming VFX (.mov files), you can import them into Avid, export the bin in TAB format to create an EDL for cutting in the VFX into the timeline. Columns: <strong className="text-white">Color</strong>, <strong className="text-white">Name</strong>, <strong className="text-white">Duration</strong>, <strong className="text-white">Start</strong>, <strong className="text-white">End</strong>, <strong className="text-white">Tape</strong>.</p>
                                        <img src="imgs/05_vfx_cutins.png" alt="Columns to export from Avid bin as TAB text file" className="rounded-lg border border-gray-700 mt-2 max-w-full" />
                                        <p className="text-xs text-gray-500 mt-1">Columns to export from Avid bin as TAB text file.</p>
                                        <p className="mt-3">Relink imported mov files like in Pulls EDL.</p>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<VFXTurnoverApp />, document.getElementById('root'));
    </script>
</body>
</html>